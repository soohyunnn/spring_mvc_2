# ë¡œê·¸ì¸ ì²˜ë¦¬1 - ì¿ í‚¤, ì„¸ì…˜

## ë¡œê·¸ì¸ ìš”êµ¬ì‚¬í•­

- í™ˆ í™”ë©´ - ë¡œê·¸ì¸ ì „
    - íšŒì› ê°€ì…
    - ë¡œê·¸ì¸
- í™ˆ í™”ë©´ - ë¡œê·¸ì¸ í›„
    - ë³¸ì¸ ì´ë¦„(ëˆ„êµ¬ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.)
    - ìƒí’ˆ ê´€ë¦¬
    - ë¡œê·¸ ì•„ì›ƒ
- ë³´ì•ˆ ìš”êµ¬ì‚¬í•­
    - ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ìƒí’ˆì— ì ‘ê·¼í•˜ê³ , ê´€ë¦¬í•  ìˆ˜ ìˆìŒ
    - ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ì‚¬ìš©ìê°€ ìƒí’ˆ ê´€ë¦¬ì— ì ‘ê·¼í•˜ë©´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
- íšŒì› ê°€ì…, ìƒí’ˆ ê´€ë¦¬

**í™ˆ í™”ë©´ ë¡œê·¸ì¸ ì „**

![Untitled](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/aeb40240-d6cf-4ed9-82cb-57977ccbcfef)

**í™ˆ í™”ë©´ - ë¡œê·¸ì¸ í›„**

![Untitled 1](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/add86439-3490-4fa6-90f5-b8602426a7d2)

**íšŒì› ê°€ì…**

![Untitled 2](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/f37984e8-b1f3-4e6d-8672-c8d4188c87b3)

**ë¡œê·¸ì¸**

![Untitled 3](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/3dcda8c5-c15c-4e6e-9646-422dc77885c7)

**ìƒí’ˆ ê´€ë¦¬**

![Untitled 4](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/05f410b1-b84c-4923-bc57-7848d0ecfd2a)

## í”„ë¡œì íŠ¸ ìƒì„±

[login.zip](https://github.com/soohyunnn/spring_mvc_2/files/11585090/login.zip)

ì´ íŒŒì¼ì„ ë‹¤ìš´ë°›ì•„ í•™ìŠµí•˜ë©´ ëœë‹¤.

### íŒ¨í‚¤ì§€ êµ¬ì¡° ì„¤ê³„

**package êµ¬ì¡°**

| hello.login |  |  |
| --- | --- | --- |
|  | domain |  |
|  |  | item |
|  |  | member |
|  |  | login |
|  | web |  |
|  |  | item |
|  |  | member |
|  |  | login |

**ë„ë©”ì¸ì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.**

ë„ë©”ì¸ = í™”ë©´, UI, ê¸°ìˆ  ì¸í”„ë¼ ë“±ë“±ì˜ ì˜ì—­ì€ ì œì™¸í•œ ì‹œìŠ¤í…œì´ êµ¬í˜„í•´ì•¼ í•˜ëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ì—…ë¬´ ì˜ì—­ì„ ë§í•œë‹¤.

í–¥í›„ webì„ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë°”ê¾¸ì–´ë„ ë„ë©”ì¸ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

ì´ë ‡ê²Œ í•˜ë ¤ë©´ webì€ domainì„ ì•Œê³ ìˆì§€ë§Œ domainì€ webì„ ëª¨ë¥´ë„ë¡ ì„¤ê³„í•´ì•¼ í•œë‹¤. ì´ê²ƒì„ webì€ domainì„ ì˜ì¡´í•˜ì§€ë§Œ, domainì€ webì„ ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í‘œí˜„í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ web íŒ¨í‚¤ì§€ë¥¼ ëª¨ë‘ ì‚­ì œí•´ë„ domainì—ëŠ” ì „í˜€ ì˜í–¥ì´ ì—†ë„ë¡ ì˜ì¡´ê´€ê³„ë¥¼ ì„¤ê³„í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤. ë°˜ëŒ€ë¡œ ì´ì—¬ê¸°í•˜ë©´ domainì€ webì„ ì°¸ì¡°í•˜ë©´ ì•ˆëœë‹¤.

## í™ˆ í™”ë©´

í™ˆ í™”ë©´ì„ ê°œë°œí•˜ì.

**HomeController - home() ìˆ˜ì •**

```java
@GetMapping("/")
public String home() {
    return "home";
}
```

`templates/home.html` ì¶”ê°€

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <link th:href="@{/css/bootstrap.min.css}"
        href="../css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container" style="max-width: 600px">
  <div class="py-5 text-center">
    <h2>í™ˆ í™”ë©´</h2>
  </div>

  <div class="row">
    <div class="col">
      <button class="w-100 btn btn-secondary btn-lg" type="button"
              th:onclick="|location.href='@{/members/add}'|">
        íšŒì› ê°€ì…
      </button>
    </div>
    <div class="col">
      <button class="w-100 btn btn-dark btn-lg" onclick="location.href='items.html'"
              th:onclick="|location.href='@{/login}'|" type="button">
        ë¡œê·¸ì¸
      </button>
    </div>
  </div>

  <hr class="my-4">

</div> <!-- /container -->

</body>
</html>
```

## íšŒì› ê°€ì…

**Member**

```java
package hello.login.domain.member;

import lombok.Data;

import javax.validation.constraints.NotEmpty;

@Data
public class Member {

    private Long id;

    @NotEmpty
    private String loginId; //ë¡œê·¸ì¸ ID

    @NotEmpty
    private String name;  //ì‚¬ìš©ì ì´ë¦„

    @NotEmpty
    private String password;

}
```

**MemberRepository**

```java
package hello.login.domain.member;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Repository;

import javax.swing.text.html.Option;
import java.util.*;

/**
 * ë™ì‹œì„± ë¬¸ì œê°€ ê³ ë ¤ë˜ì–´ ìˆì§€ ì•ŠìŒ, ì‹¤ë¬´ì—ì„œëŠ” ConcurrentHashMap, AtomicLong ì‚¬ìš© ê³ ë ¤
 */
@Slf4j
@Repository
public class MemberRepository {

    private static Map<Long, Member> store = new HashMap<>();  //static ì‚¬ìš©
    private static long sequence = 0L;  //static ì‚¬ìš©

    public Member save(Member member) {
        member.setId(++sequence);
        log.info("save: member={}", member);
        store.put(member.getId(), member);
        return member;
    }

    public Member findById(Long id) {
        return store.get(id);
    }

    public Optional<Member> findByLoginId(String loginId) {
//        List<Member> all = findAll();
//        for (Member m : all) {
//            if (m.getLoginId().equals(loginId)) {
//                return Optional.of(m);
//            }
//        }
//        return Optional.empty();

        //ìœ„ ì½”ë“œë¥¼ ëŒë‹¤ë¡œ ë³€ê²½í•˜ë©´ ì•„ë˜ ì½”ë“œê°€ ëœë‹¤.
        return findAll().stream()
                .filter(m -> m.getLoginId().equals(loginId))
                .findFirst();
    }

    public List<Member> findAll() {
        return new ArrayList<>(store.values());
    }

    public void clearStore() {
        store.clear();
    }

}
```

**MemberController**

```java
package hello.login.web.member;

import hello.login.domain.member.Member;
import hello.login.domain.member.MemberRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.validation.Valid;

@Controller
@RequiredArgsConstructor
@RequestMapping("/memers")
public class MemberController {

    private final MemberRepository memberRepository;

    @GetMapping("/add")
    public String addForm(@ModelAttribute("member") Member member) {
        return "members/addMemberForm";
    }

    @PostMapping("/add")
    public String save(@Valid @ModelAttribute Member member, BindingResult bindingResult) {
        if (bindingResult.hasErrors()) {
            return "members/addMemberForm";
        }

        memberRepository.save(member);
        return "redirect:/";
    }
}
```

@ModelAttribute(â€memberâ€)ë¥¼ @ModelAttributeë¡œ ë³€ê²½í•´ë„ ê²°ê³¼ëŠ” ê°™ë‹¤. ì—¬ê¸°ì„œëŠ” IDEì—ì„œ ì¸ì‹ ë¬¸ì œê°€ ìˆì–´ì„œ ì ìš©í–ˆë‹¤.

**íšŒì› ê°€ì… ë·° í…œí”Œë¦¿**

`templates/members/addMemberForm.html`

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link th:href="@{/css/bootstrap.min.css}"
          href="../css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 560px;
        }
        .field-error {
            border-color: #dc3545;
            color: #dc3545;
        }
    </style>
</head>
<body>

<div class="container">

    <div class="py-5 text-center">
        <h2>íšŒì› ê°€ì…</h2>
    </div>

    <h4 class="mb-3">íšŒì› ì •ë³´ ì…ë ¥</h4>

    <form action="" th:action th:object="${member}" method="post">

        <div th:if="${#fields.hasGlobalErrors()}">
            <p class="field-error" th:each="err : ${#fields.globalErrors()}" th:text="${err}">ì „ì²´ ì˜¤ë¥˜ ë©”ì‹œì§€</p>
        </div>

        <div>
            <label for="loginId">ë¡œê·¸ì¸ ID</label>
            <input type="text" id="loginId" th:field="*{loginId}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{loginId}" />
        </div>
        <div>
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" th:field="*{password}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{password}" />
        </div>
        <div>
            <label for="name">ì´ë¦„</label>
            <input type="text" id="name" th:field="*{name}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{name}" />
        </div>

        <hr class="my-4">

        <div class="row">
            <div class="col">
                <button class="w-100 btn btn-primary btn-lg" type="submit">íšŒì› ê°€ì…</button>
            </div>
            <div class="col">
                <button class="w-100 btn btn-secondary btn-lg" onclick="location.href='items.html'"
                        th:onclick="|location.href='@{/}'|"
                        type="button">ì·¨ì†Œ</button>
            </div>
        </div>

    </form>

</div> <!-- /container -->
</body>
</html>
```

**ì‹¤í–‰í•˜ê³  ë¡œê·¸ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì**

### íšŒì›ìš© í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€

í¸ì˜ìƒ í…ŒìŠ¤íŠ¸ìš© íšŒì› ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì.

> loginId : test
password : test!
name : í…ŒìŠ¤í„°
> 

**TestDataInit**

```java
package hello.login;

import hello.login.domain.item.Item;
import hello.login.domain.item.ItemRepository;
import hello.login.domain.member.Member;
import hello.login.domain.member.MemberRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;

@Component
@RequiredArgsConstructor
public class TestDataInit {

    private final ItemRepository itemRepository;
    private final MemberRepository memberRepository;

    /**
     * í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ì¶”ê°€
     */
    @PostConstruct
    public void init() {
        itemRepository.save(new Item("itemA", 10000, 10));
        itemRepository.save(new Item("itemB", 20000, 20));

        Member member = new Member();
        member.setLoginId("test");
        member.setPassword("test!");
        member.setName("í…ŒìŠ¤í„°");
        memberRepository.save(member);
    }

}
```

## ë¡œê·¸ì¸ ê¸°ëŠ¥

ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ê°œë°œí•´ë³´ì. ì§€ê¸ˆì€ ë¡œê·¸ì¸ ID, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ëŠ” ë¶€ë¶„ì— ì§‘ì¤‘í•˜ì.

![Untitled 5](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/4e0931c6-53e8-401d-9def-5f3273d67426)

**LoginService**

```java
package hello.login.domain.login;

import hello.login.domain.member.Member;
import hello.login.domain.member.MemberRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
@RequiredArgsConstructor
public class LoginService {

    private final MemberRepository memberRepository;

    /**
     *
     * @param loginId
     * @param password
     * @return nullì´ë©´ ë¡œê·¸ì¸ ì‹¤íŒ¨
     */
    public Member login(String loginId, String password) {
//        Optional<Member> findMemberOptional = memberRepository.findByLoginId(loginId);
//        Member member = findMemberOptional.get();
//
//        if (member.getPassword().equals(password)) {
//            return member;
//        } else {
//            return null;
//        }

        //ìœ„ì˜ ì½”ë“œë¥¼ ì•„ë˜ ì½”ë“œë¡œ ì¶•ì•½í•  ìˆ˜ ìˆë‹¤.
        return memberRepository.findByLoginId(loginId)
                .filter(m -> m.getPassword().equals(password))
                .orElse(null);

    }

}
```

ë¡œê·¸ì¸ì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ íšŒì›ì„ ì¡°íšŒí•œ ë‹¤ìŒì— íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ passwordì™€ ë¹„êµí•´ì„œ ê°™ìœ¼ë©´ íšŒì›ì„ ë°˜í™˜í•˜ê³ , ë§Œì•½ passwordê°€ ë‹¤ë¥´ë©´ nullì„ ë°˜í™˜í•œë‹¤.

**LoginForm**

```java
package hello.login.web.login;

import lombok.Data;

import javax.validation.constraints.NotEmpty;

@Data
public class LoginForm {

    @NotEmpty
    private String loginId;

    @NotEmpty
    private String password;

}
```

**LoginController**

```java
package hello.login.web.login;

import hello.login.domain.login.LoginService;
import hello.login.domain.member.Member;
import hello.login.web.SessionConst;
import hello.login.web.session.SessionManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

@Slf4j
@Controller
@RequiredArgsConstructor
public class LoginController {

    private final LoginService loginService;
    private final SessionManager sessionManager;

    @GetMapping("/login")
    public String loginForm(@ModelAttribute("loginForm") LoginForm form) {
        return "login/loginForm";
    }

    @PostMapping("/login")
    public String login(@Valid @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletResponse response) {
        if (bindingResult.hasErrors()) {
            return "login/loginForm";
        }

        Member loginMember = loginService.login(form.getLoginId(), form.getPassword());
        log.info("login? {}", loginMember);

        if (loginMember == null) {
            bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return "login/loginForm";
        }

        //ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬ TODO

        return "redirect:/";
    }

    @PostMapping("/logout")
    public String logout(HttpServletResponse response) {
        expireCookie(response, "memberId");
        return "redirect:/";
    }

    private static void expireCookie(HttpServletResponse response, String cookieName) {
        Cookie cookie = new Cookie(cookieName, null);
        cookie.setMaxAge(0);
        response.addCookie(cookie);
    }

}
```

ë¡œê·¸ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•´ì„œ ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ê³ , ë¡œê·¸ì¸ì— ì‹¤íŒ¨í•˜ë©´ bindingResult.reject()ë¥¼ ì‚¬ìš©í•´ì„œ ê¸€ë¡œë²Œ ì˜¤ë¥˜(ObjectError)ë¥¼ ìƒì„±í•œë‹¤. ê·¸ë¦¬ê³  ì •ë³´ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ë„ë¡ ë¡œê·¸ì¸ í¼ì„ ë·° í…œí”Œë¦¿ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

**ë¡œê·¸ì¸ í¼ ë·° í…œí”Œë¦¿**

`templates/login/loginForm.html`

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link th:href="@{/css/bootstrap.min.css}"
          href="../css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 560px;
        }
        .field-error {
            border-color: #dc3545;
            color: #dc3545;
        }
    </style>
</head>
<body>

<div class="container">

    <div class="py-5 text-center">
        <h2>ë¡œê·¸ì¸</h2>
    </div>

    <form action="item.html" th:action th:object="${loginForm}" method="post">

        <div th:if="${#fields.hasGlobalErrors()}">
            <p class="field-error" th:each="err : ${#fields.globalErrors()}" th:text="${err}">ì „ì²´ ì˜¤ë¥˜ ë©”ì‹œì§€</p>
        </div>

        <div>
            <label for="loginId">ë¡œê·¸ì¸ ID</label>
            <input type="text" id="loginId" th:field="*{loginId}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{loginId}" />
        </div>
        <div>
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" th:field="*{password}" class="form-control"
                   th:errorclass="field-error">
            <div class="field-error" th:errors="*{password}" />
        </div>

        <hr class="my-4">

        <div class="row">
            <div class="col">
                <button class="w-100 btn btn-primary btn-lg" type="submit">ë¡œê·¸ì¸</button>
            </div>
            <div class="col">
                <button class="w-100 btn btn-secondary btn-lg" onclick="location.href='items.html'"
                        th:onclick="|location.href='@{/}'|"
                        type="button">ì·¨ì†Œ</button>
            </div>
        </div>

    </form>

</div> <!-- /container -->
</body>
</html>
```

ë¡œê·¸ì¸ í¼ ë·° í…œí”Œë¦¿ì—ëŠ” íŠ¹ë³„í•œ ì½”ë“œëŠ” ì—†ë‹¤. loginId, passwordê°€ í‹€ë¦¬ë©´ ê¸€ë¡œë²Œ ì˜¤ë¥˜ê°€ ë‚˜íƒ€ë‚œë‹¤.

ì‹¤í–‰í•´ë³´ë©´ ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ë©´ í™ˆìœ¼ë¡œ ì´ë™í•˜ê³ , ë¡œê·¸ì¸ì— ì‹¤íŒ¨í•˜ë©´ â€œì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.â€ë¼ëŠ” ê²½ê³ ì™€ í•¨ê»˜ ë¡œê·¸ì¸ í¼ì´ ë‚˜íƒ€ë‚œë‹¤.

ãƒ¥ëŸ°ë° ì•„ì§ ë¡œê·¸ì¸ì´ ë˜ë©´ í™ˆ í™”ë©´ì— ê³ ê° ì´ë¦„ì´ ë³´ì—¬ì•¼ í•œë‹¤ëŠ” ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ì§€ ëª»í•œë‹¤. ë¡œê·¸ì¸ì˜ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©´ì„œ, ë¡œê·¸ì¸ì— ì„±ê³µí•œ ì‚¬ìš©ìëŠ” í™ˆ í™”ë©´ì— ì ‘ê·¼ì‹œ ì´ë¦„ì„ ë³´ì—¬ì£¼ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

## ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ê¸° - ì¿ í‚¤ ì‚¬ìš©

ğŸ’¡Â ì°¸ê³ 

ì—¬ê¸°ì„œëŠ” ì—¬ëŸ¬ë¶„ì´ ì¿ í‚¤ì˜ ê¸°ë³¸ ê°œë…ì„ ì´í•´í•˜ê³  ìˆë‹¤ê³  ê°€ì •í•œë‹¤. ì¿ í‚¤ì— ëŒ€í•´ì„œëŠ” **ëª¨ë“  ê°œë°œìë¥¼ ìœ„í•œ HTTP ê¸°ë³¸ ì§€ì‹ ê°•ì˜**ë¥¼ ì°¸ê³ í•˜ì. í˜¹ì‹œ ì˜ ìƒê°ì´ ì•ˆë‚˜ë©´ ì¿ í‚¤ ê´€ë ¨ ë‚´ìš©ì„ ê¼­! ë³µìŠµí•˜ê³  ëŒì•„ì˜¤ì.

ì¿ í‚¤ë¥¼ ì‚¬ìš©í•´ì„œ ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì.

**ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€í•˜ê¸°**

ë¡œê·¸ì¸ì˜ ìƒíƒœë¥¼ ì–´ë–»ê²Œ ìœ ì§€í•  ìˆ˜ ìˆì„ê¹Œ?

HTTP ê°•ì˜ì—ì„œ ì¼ë¶€ ì„¤ëª…í–ˆì§€ë§Œ, ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ê³„ì† ìœ ì§€í•˜ë©´ì„œ ë³´ë‚´ëŠ” ê²ƒì€ ë§¤ìš° ì–´ë µê³  ë²ˆê±°ë¡œìš´ ì‘ì—…ì´ë‹¤. ì¿ í‚¤ë¥¼ ì‚¬ìš©í•´ë³´ì.

**ì¿ í‚¤**

ì„œë²„ì—ì„œ ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ HTTP ì‘ë‹µì— ì¿ í‚¤ë¥¼ ë‹´ì•„ì„œ ë¸Œë¼ìš°ì €ì— ì „ë‹¬í•˜ì. ê·¸ëŸ¬ë©´ ë¸Œë¼ìš°ì €ëŠ” ì•ìœ¼ë¡œ í•´ë‹¹ ì¿ í‚¤ë¥¼ ì§€ì†í•´ì„œ ë³´ë‚´ì¤€ë‹¤.

**ì¿ í‚¤ ìƒì„±**

![Untitled 6](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/1af61d66-64d2-4462-aa13-42d2acec67fd)

**í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ ì „ë‹¬1**

![Untitled 7](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/8c4201e5-f238-4110-94a4-0bafbc22b120)

**í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ ì „ë‹¬2**

![Untitled 8](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/a2f0f40c-adbb-448b-8e44-00a469f92086)

**ì¿ í‚¤ì—ëŠ” ì˜ì† ì¿ í‚¤ì™€ ì„¸ì…˜ ì¿ í‚¤ê°€ ìˆë‹¤.**

- ì˜ì† ì¿ í‚¤ : ë§Œë£Œ ë‚ ì§œë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ ë‚ ì§œê¹Œì§€ ìœ ì§€
- ì„¸ì…˜ ì¿ í‚¤ : ë§Œë£Œ ë‚ ì§œë¥¼ ìƒëµí•˜ë©´ ë¸Œë¼ìš°ì € ì¢…ë£Œì‹œ ê¹Œì§€ë§Œ ìœ ì§€

ë¸Œë¼ìš°ì € ì¢…ë£Œì‹œ ë¡œê·¸ì•„ì›ƒì´ ë˜ê¸¸ ê¸°ëŒ€í•˜ë¯€ë¡œ, ìš°ë¦¬ì—ê²Œ í•„ìš”í•œ ê²ƒì€ ì„¸ì…˜ ì¿ í‚¤ì´ë‹¤.

**LoginController - login()**

ë¡œê·¸ì¸ ì„±ê³µì‹œ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ì.

```java
@PostMapping("/login")
public String login(@Valid @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletResponse response) {
    if (bindingResult.hasErrors()) {
        return "login/loginForm";
    }

    Member loginMember = loginService.login(form.getLoginId(), form.getPassword());
    log.info("login? {}", loginMember);

    if (loginMember == null) {
        bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return "login/loginForm";
    }

    //ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬

    //ì¿ í‚¤ì— ì‹œê°„ ì •ë³´ë¥¼ ì£¼ì§€ ì•Šìœ¼ë©´ ì„¸ì…˜ ì¿ ê¸°(ë¸Œë¼ìš°ì € ì¡°ë£Œì‹œ ëª¨ë‘ ì¢…ë£Œ)
    Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
    response.addCookie(idCookie);
    return "redirect:/";
}
```

**ì¿ í‚¤ ìƒì„± ë¡œì§**

```java
Cookie idCookie = new Cookie("memberId", String.valueOf(loginMember.getId()));
response.addCookie(idCookie);
```

ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ê³  `HttpServletResponse`ì— ë‹´ëŠ”ë‹¤. ì¿ í‚¤ ì´ë¦„ì€ `memberId`ì´ê³ , ê°’ì€ íšŒì›ì˜ idë¥¼ ë‹´ì•„ë‘”ë‹¤. ì›¹ ë¸Œë¼ìš°ì €ëŠ” ì¢…ë£Œ ì „ê¹Œì§€ íšŒì›ì˜ `id`ë¥¼ ì„œë²„ì— ê³„ì† ë³´ë‚´ì¤„ ê²ƒì´ë‹¤.

í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ HTTP ì‘ë‹µ í—¤ë”ì— ì¿ í‚¤ê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Untitled 9](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/ddd0b994-9c4c-4f05-9438-32f4bab225bf)

ë¡œê·¸ì¸ í›„ ë„¤íŠ¸ì›Œí¬ì—ì„œ api í—¤ë”ë¥¼ í™•ì¸í•´ë³´ë©´ `Set-Cookie: memberId=1` ë¡œ ì¿ í‚¤ê°€ ì €ì¥ë˜ëŠ”ê²ƒì„ í™•ì¸í•´ë³¼ ìˆ˜ ìˆë‹¤.

**í™ˆ - ë¡œê·¸ì¸ ì²˜ë¦¬**

```java
package hello.login.web;

import hello.login.domain.member.Member;
import hello.login.domain.member.MemberRepository;
import hello.login.web.session.SessionManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.CookieValue;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.SessionAttribute;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

@Slf4j
@Controller
@RequiredArgsConstructor
public class HomeController {

    private final MemberRepository memberRepository;
    private final SessionManager sessionManager;

    //    @GetMapping("/")
    public String home() {
        return "home";
    }

    @GetMapping("/")
    public String homeLogin(@CookieValue(name = "memberId", required = false) Long memberId, Model model) {

        if (memberId == null) {
            return "home";
        }

        //ë¡œê·¸ì¸
        Member loginMember = memberRepository.findById(memberId);
        if (loginMember == null) {
            return "home";
        }

        model.addAttribute("member", loginMember);
        return "loginHome";
    }

}
```

- ê¸°ì¡´ `home()`ì— ìˆëŠ” `@GetMapping(â€/â€)`ì€ ì£¼ì„ ì²˜ë¦¬í•˜ì.
- `@CookieValue`ë¥¼ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•˜ê²Œ ì¿ í‚¤ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.
- ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ì‚¬ìš©ìë„ í™ˆì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— `required = false`ë¥¼ ì‚¬ìš©í•œë‹¤.

**ë¡œì§ ë¶„ì„**

- ë¡œê·¸ì¸ ì¿ í‚¤(`memberId`)ê°€ ì—†ëŠ” ì‚¬ìš©ìëŠ” ê¸°ì¡´ `home`ìœ¼ë¡œ ë³´ë‚¸ë‹¤. ì¶”ê°€ë¡œ ë¡œê·¸ì¸ ì¿ í‚¤ê°€ ìˆì–´ë„ íšŒì›ì´ ì—†ìœ¼ë©´ `home`ìœ¼ë¡œ ë³´ë‚¸ë‹¤.
- ë¡œê·¸ì¸ ì¿ í‚¤(`memberId`)ê°€ ìˆëŠ” ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ ì‚¬ìš©ì ì „ìš© í™ˆ í™”ë©´ì¸ `loginHome`ìœ¼ë¡œ ë³´ë‚¸ë‹¤. ì¶”ê°€ë¡œ í™ˆ í™”ë©´ì— íšŒì› ê´€ë ¨ ì •ë³´ë„ ì¶œë ¥í•´ì•¼ í•´ì„œ `member` ë°ì´í„°ë„ ëª¨ë¸ì— ë‹´ì•„ì„œ ì „ë‹¬í•œë‹¤.

**í™ˆ - ë¡œê·¸ì¸ ì‚¬ìš©ì ì „ìš©**

`templates/loginHome.html`

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link th:href="@{/css/bootstrap.min.css}"
          href="../css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container" style="max-width: 600px">
    <div class="py-5 text-center">
        <h2>í™ˆ í™”ë©´</h2>
    </div>

    <h4 class="mb-3" th:text="|ë¡œê·¸ì¸: ${member.name}|">ë¡œê·¸ì¸ ì‚¬ìš©ì ì´ë¦„</h4>

    <hr class="my-4">

    <div class="row">
        <div class="col">
            <button class="w-100 btn btn-secondary btn-lg" type="button"
                    th:onclick="|location.href='@{/items}'|">
                ìƒí’ˆ ê´€ë¦¬
            </button>
        </div>
        <div class="col">
            <form th:action="@{/logout}" method="post">
                <button class="w-100 btn btn-dark btn-lg" onclick="location.href='items.html'" type="submit">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </form>
        </div>
    </div>

    <hr class="my-4">

</div> <!-- /container -->

</body>
</html>
```

- `th:text=â€|ë¡œê·¸ì¸: ${member.name}|â€` : ë¡œê·¸ì¸ì— ì„±ê³µí•œ ì‚¬ìš©ì ì´ë¦„ì„ ì¶œë ¥í•œë‹¤.
- ìƒí’ˆ ê´€ë¦¬, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ë…¸ì¶œí•œë‹¤.

ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì‚¬ìš©ì ì´ë¦„ì´ ì¶œë ¥ë˜ë©´ì„œ ìƒí’ˆ ê´€ë¦¬, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë¡œê·¸ì¸ì— ì„±ê³µì‹œ ì„¸ì…˜ ì¿ í‚¤ê°€ ì§€ì†í•´ì„œ ìœ ì§€ë˜ê³ , ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì„œë²„ì— ìš”ì²­ì‹œ memberId ì¿ í‚¤ë¥¼ ê³„ì† ë³´ë‚´ì¤€ë‹¤.

### ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥

ì´ë²ˆì—ëŠ” ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ë³´ì. ë¡œê·¸ì•„ì›ƒ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- ì„¸ì…˜ ì¿ í‚¤ì´ë¯€ë¡œ ì›¹ ë¸Œë¼ìš°ì € ì¢…ë£Œì‹œ
- ì„œë²„ì—ì„œ í•´ë‹¹ ì¿ í‚¤ì˜ ì¢…ë£Œ ë‚ ì§œë¥¼ 0ìœ¼ë¡œ ì§€ì •

**LoginController - logout ê¸°ëŠ¥ ì¶”ê°€**

```java
@PostMapping("/logout")
public String logout(HttpServletResponse response) {
    expireCookie(response, "memberId");
    return "redirect:/";
}

private static void expireCookie(HttpServletResponse response, String cookieName) {
    Cookie cookie = new Cookie(cookieName, null);
    cookie.setMaxAge(0);
    response.addCookie(cookie);
}
```

ë¡œê·¸ì•„ì›ƒë„ ì‘ë‹µ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ëŠ”ë° `Max-Age=0`ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ì¿ í‚¤ëŠ” ì¦‰ì‹œ ì¢…ë£Œëœë‹¤.

## ì¿ í‚¤ì™€ ë³´ì•ˆ ë¬¸ì œ

ì¿ í‚¤ë¥¼ ì‚¬ìš©í•´ì„œ ë¡œê·¸ì¸Idë¥¼ ì „ë‹¬í•´ì„œ ë¡œê·¸ì¸ì„ ìœ ì§€í•  ìˆ˜ ìˆì—ˆë‹¤. ê·¸ëŸ°ë° ì—¬ê¸°ì—ëŠ” ì‹¬ê°í•œ ë³´ì•ˆ ë¬¸ì œê°€ ìˆë‹¤.

**ë³´ì•ˆ ë¬¸ì œ**

- ì¿ í‚¤ ê°’ì€ ì„ì˜ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
    - í´ë¼ì´ì–¸íŠ¸ê°€ ì¿ í‚¤ë¥¼ ê°•ì œë¡œ ë³€ê²½í•˜ë©´ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ëœë‹¤.
    - ì‹¤ì œ ì›¹ë¸Œë¼ìš°ì € ê°œë°œìëª¨ë“œ â†’ Application â†’ Cookie ë³€ê²½ìœ¼ë¡œ í™•ì¸
    - `Cookie: memberId=1` â†’ `Cookie: memberId=2` (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì´ë¦„ì´ ë³´ì„)
- ì¿ í‚¤ì— ë³´ê´€ëœ ì •ë³´ëŠ” í›”ì³ê°ˆ ìˆ˜ ìˆë‹¤.
    - ë§Œì•½ ì¿ í‚¤ì— ê°œì¸ì •ë³´ë‚˜, ì‹ ìš©ì¹´ë“œ ì •ë³´ê°€ ìˆë‹¤ë©´?
    - ì´ ì •ë³´ê°€ ì›¹ ë¸Œë¼ìš°ì €ì—ë„ ë³´ê´€ë˜ê³ , ë„¤íŠ¸ì›Œí¬ ìš”ì²­ë§ˆë‹¤ ê³„ì† í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ì „ë‹¬ëœë‹¤.
    - ì¿ í‚¤ì˜ ì •ë³´ê°€ ë‚˜ì˜ ë¡œì»¬ PCì—ì„œ í„¸ë¦´ ìˆ˜ë„ ìˆê³ , ë„¤íŠ¸ì¿¼ìœ¼ ì „ì†¡ êµ¬ê°„ì—ì„œ í„¸ë¦´ ìˆ˜ë„ ìˆë”°.
- í•´ì»¤ê°€ ì¿ í‚¤ë¥¼ í•œë²ˆ í›”ì³ê°€ë©´ í‰ìƒ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
    - í•´ì»¤ê°€ ì¿ í‚¤ë¥¼ í›”ì³ê°€ì„œ ê·¸ ì¿ í‚¤ë¡œ ì•…ì˜ì ì¸ ìš”ì²­ì„ ê³„ì† ì‹œë„í•  ìˆ˜ ìˆë‹¤.

**ëŒ€ì•ˆ**

- ì¿ í‚¤ì— ì¤‘ìš”í•œ ê°’ì„ ë…¸ì¶œí•˜ì§€ ì•Šê³ , ì‚¬ìš©ì ë³„ë¡œ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ì„ì˜ì˜ í† í°(ëœë¤ ê°’)ì„ ë…¸ì¶œí•˜ê³ , ì„œë²„ì—ì„œ í† í°ê³¼ ì‚¬ìš©ì idë¥¼ ë§¤í•‘í•´ì„œ ì¸ì‹í•œë‹¤. ê·¸ë¦¬ê³  ì„œë²„ì—ì„œ í† í°ì„ ê´€ë¦¬í•œë‹¤.
- í† í°ì€ í•´ì»¤ê°€ ì„ì˜ì˜ ê°’ì„ ë„£ì–´ë„ ì°¾ì„ ìˆ˜ ì—†ë„ë¡ ì˜ˆìƒ ë¶ˆê°€ëŠ¥ í•´ì•¼ í•œë‹¤.
- í•´ì»¤ê°€ í† í°ì„ í„¸ì–´ê°€ë„ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì‚¬ìš©í•  ìˆ˜ ì—†ë„ë¡ ì„œë²„ì—ì„œ í•´ë‹¹ í† í°ì˜ ë§Œë£Œì‹œê°„ì„ ì§§ê²Œ(ì˜ˆ: 30ë¶„) ìœ ì§€í•œë‹¤. ë˜ëŠ” í•´í‚¹ì´ ì˜ì‹¬ë˜ëŠ” ê²½ìš° ì„œë²„ì—ì„œ í•´ë‹¹ í† í°ì„ ê°•ì œë¡œ ì œê±°í•˜ë©´ ëœë‹¤.

## ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ê¸° - ì„¸ì…˜ ë™ì‘ ë°©ì‹

**ëª©í‘œ**

ì•ì„œ ì¿ í‚¤ì— ì¤‘ìš”í•œ ì •ë³´ë¥¼ ë³´ê´€í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ê°€ì§€ ë³´ì•ˆ ì´ìŠˆê°€ ìˆì—ˆë‹¤. ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ê²°êµ­ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ëª¨ë‘ ì„œë²„ì— ì €ì¥í•´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ëŠ” ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ì„ì˜ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ ì—°ê²°í•´ì•¼ í•œë‹¤.

ì´ë ‡ê²Œ ì„œë²„ì— ì¤‘ìš”í•œ ì •ë³´ë¥¼ ë³´ê´€í•˜ê³  ì—°ê²°ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì„ ì„¸ì…˜ì´ë¼ í•œë‹¤.

### ì„¸ì…˜ ë™ì‘ ë°©ì‹

ì„¸ì…˜ì„ ì–´ë–»ê²Œ ê°œë°œí• ì§€ ë¨¼ì € ê°œë…ì„ ì´í•´í•´ë³´ì.

**ë¡œê·¸ì¸**

![Untitled 10](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/d1759172-e04a-4d92-bb0d-af221efbeea3)

- ì‚¬ìš©ìê°€ `loginId`, `password` ì •ë³´ë¥¼ ì „ë‹¬í•˜ë©´ ì„œë²„ì—ì„œ í•´ë‹¹ ì‚¬ìš©ìê°€ ë§ëŠ”ì§€ í™•ì¸í•œë‹¤.

**ì„¸ì…˜ ìƒì„±**

![Untitled 11](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/7f33a101-8aac-473c-b093-d8fb04dacfff)

- ì„¸ì…˜ IDë¥¼ ìƒì„±í•˜ëŠ”ë°, ì¶”ì • ë¶ˆê°€ëŠ¥í•´ì•¼ í•œë‹¤.
- UUIDëŠ” ì¶”ì •ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
    - `Cookie: mySessionId=zz0101xx-bab9-4b92-9b32-dadb280f4b61`
- ìƒì„±ëœ ì„¸ì…˜ IDì™€ ì„¸ì…˜ì— ë³´ê´€í•  ê°’(`memberA`)ì„ ì„œë²„ì˜ ì„¸ì…˜ ì €ì¥ì†Œì— ë³´ê´€í•œë‹¤.

**ì„¸ì…˜idë¥¼ ì‘ë‹µ ì¿ í‚¤ë¡œ ì „ë‹¬**

![Untitled 12](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/ebb3d231-4783-4488-8747-1b454f6d4f6a)

**í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ëŠ” ê²°êµ­ ì¿ í‚¤ë¡œ ì—°ê²°ì´ ë˜ì–´ì•¼ í•œë‹¤.**

- ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì— `meSessionId`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì„¸ì…˜IDë§Œ ì¿ í‚¤ì— ë‹´ì•„ì„œ ì „ë‹¬í•œë‹¤.
- í´ë¼ì´ì–¸íŠ¸ëŠ” ì¿ í‚¤ ì €ì¥ì†Œì— `mySessionId` ì¿ í‚¤ë¥¼ ë³´ê´€í•œë‹¤.

**ì¤‘ìš”**

- ì—¬ê¸°ì„œ ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ” íšŒì›ê³¼ ê´€ë ¨ëœ ì •ë³´ëŠ” ì „í˜€ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì´ë‹¤.
- ì˜¤ì§ ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ì„¸ì…˜ IDë§Œ ì¿ í‚¤ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬í•œë‹¤.

**í´ë¼ì´ì–¸íŠ¸ì˜ ì„¸ì…˜id ì¿ í‚¤ ì „ë‹¬**

![Untitled 13](https://github.com/soohyunnn/spring_mvc_2/assets/58289675/a072f075-8a6c-4a1f-8101-d8c0821a432d)

- í´ë¼ì´ì–¸íŠ¸ëŠ” ìš”ì²­ì‹œ í•­ìƒ `mySessionId` ì¿ í‚¤ë¥¼ ì „ë‹¬í•œë‹¤.
- ì„œë²„ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬í•œ `mySessionId` ì¿ í‚¤ ì •ë³´ë¡œ ì„¸ì…˜ ì €ì¥ì†Œë¥¼ ì¡°íšŒí•´ì„œ ë¡œê·¸ì¸ì‹œ ë³´ê´€í•œ ì„¸ì…˜ ì •ë³´ë¥¼ ì‚¬ìš©í•œë‹¤.

**ì •ë¦¬**

ì„¸ì…˜ì„ ì‚¬ìš©í•´ì„œ ì„œë²„ì—ì„œ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê²Œ ë˜ì—ˆë‹¤. ë•ë¶„ì— ë‹¤ìŒê³¼ ê°™ì€ ë³´ì•ˆ ë¬¸ì œë“¤ì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

- ì¿ í‚¤ ê°’ì„ ë³€ì¡° ê°€ëŠ¥ â†’ ì˜ˆìƒ ë¶ˆê°€ëŠ¥í•œ ë³µì¡í•œ ì„¸ì…˜Idë¥¼ ì‚¬ìš©í•œë‹¤.
- ì¿ í‚¤ì— ë³´ê´€í•˜ëŠ” ì •ë³´ëŠ” í´ë¼ì´ì–¸íŠ¸ í•´í‚¹ì‹œ í„¸ë¦´ ê°€ëŠ¥ì„±ì´ ìˆë‹¤. ì„¸ì…˜Idê°€ í„¸ë ¤ë„ ì—¬ê¸°ì—ëŠ” ì¤‘ìš”í•œ ì •ë³´ê°€ ì—†ë‹¤.
- ì¿ í‚¤ íƒˆì·¨ í›„ ì‚¬ìš© â†’ í•´ì»¤ê°€ í† í°ì„ í„¸ì–´ê°€ë„ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì‚¬ìš©í•  ìˆ˜ ì—†ë„ë¡ ì„œë²„ì—ì„œ ì„¸ì…˜ì˜ ë§Œë£Œì‹œê°„ì„ ì§§ê²Œ(ì˜ˆ: 30ë¶„) ìœ ì§€í•œë‹¤. ë˜ëŠ” í•´í‚¹ì´ ì˜ì‹¬ë˜ëŠ” ê²½ìš° ì„œë²„ì—ì„œ í•´ë‹¹ ì„¸ì…˜ì„ ê°•ì œë¡œ ì œê±°í•˜ë©´ ëœë‹¤.

## ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ê¸° - ì„¸ì…˜ ì§ì ‘ ë§Œë“¤ê¸°

ì„¸ì…˜ì„ ì§ì ‘ ê°œë°œí•´ì„œ ì ìš©í•´ë³´ì.

ì„¸ì…˜ ê´€ë¦¬ëŠ” í¬ê²Œ ë‹¤ìŒ 3ê°€ì§€ ê¸°ëŠ¥ì„ ì œê³µí•˜ë©´ ëœë‹¤.

- ì„¸ì…˜ ìƒì„±
    - sessionId ìƒì„± (ì„ì˜ì˜ ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ëœë¤ ê°’)
    - ì„¸ì…˜ ì €ì¥ì†Œì— sessionIdì™€ ë³´ê´€í•  ê°’ ì €ì¥
    - sessionIdë¡œ ì‘ë‹µ ì¿ í‚¤ë¥¼ ìƒì„±í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬
- ì„¸ì…˜ ì¡°íšŒ
    - í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•œ sessionId ì¿ í‚¤ì˜ ê°’ìœ¼ë¡œ, ì„¸ì…˜ ì €ì¥ì†Œì— ë³´ê´€í•œ ê°’ ì¡°íšŒ
- ì„¸ì…˜ ë§Œë£Œ
    - í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í•œ sessionId ì¿ í‚¤ì˜ ê°’ìœ¼ë¡œ, ì„¸ì…˜ ì €ì¥ì†Œì— ë³´ê´€í•œ sessionIdì™€ ê°’ ì œê±°

**SessionManager - ì„¸ì…˜ ê´€ë¦¬**

```java
package hello.login.web.session;

import org.springframework.stereotype.Component;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.Arrays;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

/**
 * ì„¸ì…˜ ê´€ë¦¬
 */
@Component
public class SessionManager {

    public static final String SESSION_COOKIE_NAME = "mySessionId";
    private Map<String, Object> sessionStore = new ConcurrentHashMap<>();

    /**
     * ì„¸ì…˜ ìƒì„±
     * sessionId ìƒì„± (ì„ì˜ì˜ ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ëœë¤ ê°’)
     * ì„¸ì…˜ ì €ì¥ì†Œì— sessionIdì™€ ë³´ê´€í•  ê°’ ì €ì¥
     * sessionIdë¡œ ì‘ë‹µ ì¿ ê¸°ë¥¼ ìƒì„±í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬
     */
    public void createSession(Object value, HttpServletResponse response) {

        //ì„¸ì…˜ idë¥¼ ìƒì„±í•˜ê³ , ê°’ì„ ì„¸ì…˜ì— ì €ì¥
        String sessionId = UUID.randomUUID().toString();
        sessionStore.put(sessionId, value);

        //ì¿ í‚¤ ìƒì„±
        Cookie mySessionCokie = new Cookie(SESSION_COOKIE_NAME, sessionId);
        response.addCookie(mySessionCokie);
    }

    /**
     * ì„¸ì…˜ ì¡°íšŒ
     */
    public Object getSession(HttpServletRequest request) {
//        Cookie[] cookies = request.getCookies();
//        if (cookies == null) {
//            return null;
//        }
//        for (Cookie cookie : cookies) {
//            if (cookie.getName().equals(SESSION_COOKIE_NAME)) {
//                return sessionStore.get(cookie.getValue());
//            }
//        }
//        return null;

        //ìœ„ ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ë¦¬íŒ©í† ë§!
        Cookie sessionCookie = findCookie(request, SESSION_COOKIE_NAME);
        if (sessionCookie == null) {
            return null;
        }
        return sessionStore.get(sessionCookie.getValue());
    }

    /**
     * ì„¸ì…˜ ë§Œë£Œ
     */
    public void expire(HttpServletRequest request) {
        Cookie sessionCookie = findCookie(request, SESSION_COOKIE_NAME);
        if (sessionCookie != null) {
            sessionStore.remove(sessionCookie.getValue());
        }
    }

    public Cookie findCookie(HttpServletRequest request, String cookieName) {
        Cookie[] cookies = request.getCookies();
        if (cookies == null) {
            return null;
        }

        return Arrays.stream(request.getCookies())
                .filter(cookie -> cookie.getName().equals(cookieName))
                .findAny()
                .orElse(null);
    }

}
```

ë¡œì§ì€ ì–´ë µì§€ ì•Šì•„ì„œ ì‰½ê²Œ ì´í•´ê°€ ë  ê²ƒì´ë‹¤.

- `@Component` : ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ìë™ ë“±ë¡í•œë‹¤.
- `ConcurrentHashMap` : `HashMap`ì€ ë™ì‹œ ìš”ì²­ì— ì•ˆì „í•˜ì§€ ì•Šë‹¤. ë™ì‹œ ìš”ì²­ì— ì•ˆì „í•œ `ConcurrentHashMap`ë¥¼ ì‚¬ìš©í–ˆë‹¤.

**SessionManagerTest - í…ŒìŠ¤íŠ¸**

```java
package hello.login.web.session;

import hello.login.domain.member.Member;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.mock.web.MockHttpServletRequest;
import org.springframework.mock.web.MockHttpServletResponse;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.*;

class SessionManagerTest {

    SessionManager sessionManager = new SessionManager();

    @Test
    void sessionTest() {
        //ì„¸ì…˜ ìƒì„±
        MockHttpServletResponse response = new MockHttpServletResponse();
        Member member = new Member();
        sessionManager.createSession(member, response);

        //ìš”ì²­ì— ì‘ë‹µ ì¿ í‚¤ ì €ì¥
        MockHttpServletRequest request = new MockHttpServletRequest();
        request.setCookies(response.getCookies());

        //ì„¸ì…˜ ì¡°íšŒ
        Object result = sessionManager.getSession(request);
        assertThat(result).isEqualTo(member);

        //ì„¸ì…˜ ë§Œë£Œ
        sessionManager.expire(request);
        Object expired = sessionManager.getSession(request);
        assertThat(expired).isNull();
    }

}
```

ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ì. ì—¬ê¸°ì„œëŠ” `HttpServletRequest`, `HttpservletResponse` ê°ì²´ë¥¼ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ì—ì„œ ë¹„ìŠ·í•œ ì—­í• ì„ í•´ì£¼ëŠ” ê°€ì§œ `MockHttpServletRequest`, `MockHttpServletResponse`ë¥¼ ì‚¬ìš©í–ˆë‹¤.

## ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ê¸° - ì§ì ‘ ë§Œë“  ì„¸ì…˜ ì ìš©

ì§€ê¸ˆê¹Œì§€ ê°œë°œí•œ ì„¸ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‹¤ì œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ìš©í•´ë³´ì.

**LoginController - loginV2()**

```java
@PostMapping("/login")
public String loginV2(@Valid @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletResponse response) {
    if (bindingResult.hasErrors()) {
        return "login/loginForm";
    }

    Member loginMember = loginService.login(form.getLoginId(), form.getPassword());
    log.info("login? {}", loginMember);

    if (loginMember == null) {
        bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return "login/loginForm";
    }

    //ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬

    //ì„¸ì…˜ ê´€ë¦¬ìë¥¼ í†µí•´ ì„¸ì…˜ì„ ìƒì„±í•˜ê³ , íšŒì› ë°ì´í„° ë³´ê´€
    sessionManager.createSession(loginMember, response);

    return "redirect:/";
}
```

- ê¸°ì¡´ login()ì˜ @PostMapping(â€/loginâ€) ì£¼ì„ ì²˜ë¦¬

- private final SessionManager sessionManager; ì£¼ì…
- sessionManager.createSession(loginMember, response);
    
    ë¡œê·¸ì¸ ì„±ê³µì‹œ ì„¸ì…˜ì„ ë“±ë¡í•œë‹¤. ì„¸ì…˜ì— loginMemberë¥¼ ì €ì¥í•´ë‘ê³ , ì¿ í‚¤ë„ í•¨ê»˜ ë°œí–‰í•œë‹¤.
    

**LoginController - logoutV2()**

```java
@PostMapping("/logout")
public String logoutV2(HttpServletRequest request) {
    sessionManager.expire(request);
    return "redirect:/";
}
```

ë¡œê·¸ ì•„ì›ƒì‹œ í•´ë‹¹ ì„¸ì…˜ì˜ ì •ë³´ë¥¼ ì œê±°í•œë‹¤.

**HomeController - homeLoginV2()**

```java
@GetMapping("/")
public String homeLoginV2(HttpServletRequest request, Model model) {

    //ì„¸ì…˜ ê´€ë¦¬ìì— ì €ì¥ëœ íšŒì› ì •ë³´ ì¡°íšŒ
    Member member = (Member) sessionManager.getSession(request);
    if (member == null) {
        return "home";
    }

    //ë¡œê·¸ì¸
    model.addAttribute("member", member);
    return "loginHome";
}
```

- private final SessionManager sessionManager; ì£¼ì…
- ê¸°ì¡´ homeLogin()ì˜ @GetMapping(â€/â€) ì£¼ì„ ì²˜ë¦¬

ì„¸ì…˜ ê´€ë¦¬ìì—ì„œ ì €ì¥ëœ íšŒì› ì •ë³´ë¥¼ ì¡°íšŒí•œë‹¤. ë§Œì•½ íšŒì› ì •ë³´ê°€ ì—†ìœ¼ë©´, ì¿ í‚¤ë‚˜ ì„¸ì…˜ì´ ì—†ëŠ” ê²ƒì´ë¯€ë¡œ ë¡œê·¸ì¸ ë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

**ì •ë¦¬**

ì„¸ì…˜ê³¼ ì¿ í‚¤ì˜ ê°œë…ì„ ëª…í™•í•˜ê²Œ ì´í•´í•˜ê¸° ìœ„í•´ì„œ ì§ì ‘ ë§Œë“¤ì–´ë³´ì•˜ë‹¤. ì‚¬ì‹¤ ì„¸ì…˜ì´ë¼ëŠ” ê²ƒì´ ë­”ê°€ íŠ¹ë³„í•œ ê²ƒì´ ì•„ë‹ˆë¼ ë‹¨ì§€ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ëŠ” ë°©ë²•ì¼ ë¿ì´ë¼ëŠ” ê²ƒì„ ì´í•´í–ˆì„ ê²ƒì´ë‹¤.

ê·¸ëŸ°ë° í”„ë¡œì íŠ¸ë§ˆë‹¤ ì´ëŸ¬í•œ ì„¸ì…˜ ê°œë…ì„ ì§ì ‘ ê°œë°œí•˜ëŠ” ê²ƒì€ ìƒë‹¹íˆ ë¶ˆí¸í•  ê²ƒì´ë‹¤. ê·¸ë˜ì„œ ì„œë¸”ë¦¿ë„ ì„¸ì…˜ ê°œë…ì„ ì§€ì›í•œë‹¤.

ì´ì œ ì§ì ‘ ë§Œë“œëŠ” ì„¸ì…˜ ë§ê³ , ì„œë¸”ë¦¿ì´ ê³µì‹ ì§€ì›í•˜ëŠ” ì„¸ì…˜ì„ ì•Œì•„ë³´ì. ì„œë¸”ë¦¿ì´ ê³µì‹ ì§€ì›í•˜ëŠ” ì„¸ì…˜ì€ ìš°ë¦¬ê°€ ì§ì ‘ ë§Œë“  ì„¸ì…˜ê³¼ ë™ì‘ ë°©ì‹ì´ ê±°ì˜ ê°™ë‹¤. ì¶”ê°€ë¡œ ì„¸ì…˜ì„ ì¼ì •ì‹œê°„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì„¸ì…˜ì„ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

## ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ê¸° - ì„œë¸”ë¦¿ HTTP ì„¸ì…˜1

ì„¸ì…˜ì´ë¼ëŠ” ê°œë…ì€ ëŒ€ë¶€ë¶„ì˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— í•„ìš”í•œ ê²ƒì´ë‹¤. ì–´ì©Œë©´ ì›¹ì´ ë“±ì¥í•˜ë©´ì„œ ë¶€í„° ë‚˜ì˜¨ ë¬¸ì œì´ë‹¤.

ì„œë¸”ë¦¿ì€ ì„¸ì…˜ì„ ìœ„í•´ `HttpSession`ì´ë¼ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ”ë°, ì§€ê¸ˆê¹Œì§€ ë‚˜ì˜¨ ë¬¸ì œë“¤ì„ í•´ê²°í•´ì¤€ë‹¤.

ìš°ë¦¬ê°€ ì§ì ‘ êµ¬í˜„í•œ ì„¸ì…˜ì˜ ê°œë…ì´ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆê³ , ë” ì˜ êµ¬í˜„ë˜ì–´ ìˆë‹¤.

**HttpSeesion ì†Œê°œ**

ì„œë¸”ë¦¿ì´ ì œê³µí•˜ëŠ” `HttpSession`ë„ ê²°êµ­ ìš°ë¦¬ê°€ ì§ì ‘ ë§Œë“  `SessionManager`ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤. ì„œë¸”ë¦¿ì„ í†µí•´ `HttpSession`ì„ ìƒì„±í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¿ í‚¤ë¥¼ ìƒì„±í•œë‹¤. ì¿ í‚¤ ì´ë¦„ì€ `JSESSIONID`ì´ê³ , ê°’ì€ ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ëœë¤ ê°’ì´ë‹¤.

`Cookie: JSESSIONID=5B78E23B513F50164D6FDD8C97B0AD05`

### HttpSession ì‚¬ìš©

ì„œë¸”ë¦¿ì´ ì œê³µí•˜ëŠ” HttpSessionì„ ì‚¬ìš©í•˜ë„ë¡ ê°œë°œí•´ë³´ì.

**SessionConst**

```java
package hello.login.web;

public class SessionConst {
    public static final String LOGIN_MEMBER = "loginMember";
}
```

`HttpSession`ì— ë°ì´í„°ë¥¼ ë³´ê´€í•˜ê³  ì¡°íšŒí•  ë•Œ, ê°™ì€ ì´ë¦„ì´ ì¤‘ë³µ ë˜ì–´ ì‚¬ìš©ë˜ë¯€ë¡œ, ìƒìˆ˜ë¥¼ í•˜ë‚˜ ì •ì˜í–ˆë‹¤.

**LoginController - loginV3()**

```java
@PostMapping("/login")
public String loginV3(@Valid @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletRequest request) {
    if (bindingResult.hasErrors()) {
        return "login/loginForm";
    }

    Member loginMember = loginService.login(form.getLoginId(), form.getPassword());
    log.info("login? {}", loginMember);

    if (loginMember == null) {
        bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return "login/loginForm";
    }

    //ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬

    //ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìˆëŠ” ì„¸ì…˜ ë°˜í™˜, ì—†ìœ¼ë©´ ì‹ ê·œ ì„¸ì…˜ ìƒì„±
    HttpSession session = request.getSession();
    //ì„¸ì…˜ì— ë¡œê·¸ì¸ íšŒì› ì •ë³´ ë³´ê´€
    session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);

    return "redirect:/";
}
```

- ê¸°ì¡´ `loginV2()`ì˜ `@PostMapping(â€/loginâ€)` ì£¼ì„ ì²˜ë¦¬

**ì„¸ì…˜ ìƒì„±ê³¼ ì¡°íšŒ**

ì„¸ì…˜ì„ ìƒì„±í•˜ë ¤ë©´ `request.getSession(true)`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

`public HttpSession getSession(boolean create);`

ì„¸ì…˜ì˜ `create` ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë³´ì.

- `request.getSession(true)`
    - ì„¸ì…˜ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ì„¸ì…˜ì„ ë°˜í™˜í•œë‹¤.
    - ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•´ì„œ ë°˜í™˜í•œë‹¤.
- `request.getSession(false)`
    - ì„¸ì…˜ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ì„¸ì…˜ì„ ë°˜í™˜í•œë‹¤.
    - ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤. `null`ì„ ë°˜í™˜í•œë‹¤.

- `request.getSession()` : ì‹ ê·œ ì„¸ì…˜ì„ ìƒì„±í•˜ëŠ” `request.getSession(true)`ì™€ ë™ì¼í•˜ë‹¤.

**ì„¸ì…˜ì— ë¡œê·¸ì¸ íšŒì› ì •ë³´ ë³´ê´€**

`session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);`

ì„¸ì…˜ì— ë°ì´í„°ë¥¼ ë³´ê´€í•˜ëŠ” ë°©ë²•ì€ `request.setAttribute(â€¦)`ì™€ ë¹„ìŠ·í•˜ë‹¤. í•˜ë‚˜ì˜ ì„¸ì…˜ì— ì—¬ëŸ¬ ê°’ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

**LoginController - logoutV3()**

```java
@PostMapping("/logout")
public String logoutV3(HttpServletRequest request) {
    //ì„¸ì…˜ì„ ì‚­ì œí•œë‹¤.
    HttpSession session = request.getSession(false);
    if (session != null) {
        session.invalidate();
    }
    return "redirect:/";
}
```

- ê¸°ì¡´ `logoutV2()`ì˜ `@PostMapping(â€/logoutâ€)` ì£¼ì„ ì²˜ë¦¬

`session.invalidate()` : ì„¸ì…˜ì„ ì œê±°í•œë‹¤.

**HomeController - homeLoginV3()**

```java
@GetMapping("/")
public String homeLoginV3(HttpServletRequest request, Model model) {

    //ì„¸ì…˜ì´ ì—†ìœ¼ë©´ home
    HttpSession session = request.getSession(false);
    if (session == null) {
        return "home";
    }

    Member loginMember = (Member) session.getAttribute(SessionConst.LOGIN_MEMBER);
    //ì„¸ì…˜ì— íšŒì› ë°ì´í„°ê°€ ì—†ìœ¼ë©´ home
    if (loginMember == null) {
        return "home";
    }

    //ì„¸ì…˜ì´ ìœ ì§€ë˜ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ ì´ë™
    model.addAttribute("member", loginMember);
    return "loginHome";
}
```

- ê¸°ì¡´ `homeLoginV2()`ì˜ `@GetMapping(â€/â€)` ì£¼ì„ ì²˜ë¦¬

- `request.getSession(false)` : `request.getSession()`ë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ ê°’ì´ `create: true` ì´ë¯€ë¡œ, ë¡œê·¸ì¸ í•˜ì§€ ì•Šì„ ì‚¬ìš©ìë„ ì˜ë¯¸ì—†ëŠ” ì„¸ì…˜ì´ ë§Œë“¤ì–´ì§„ë‹¤. ë”°ë¼ì„œ ì„¸ì…˜ì„ ì°¾ì•„ì„œ ì‚¬ìš©í•˜ëŠ” ì‹œì ì—ëŠ” `create: false` ì˜µì…˜ì„ ì‚¬ìš©í•´ì„œ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.
- `session.getAttribute(SessionConst.LOGIN_MEMBER)` : ë¡œê·¸ì¸ ì‹œì ì— ì„¸ì…˜ì— ë³´ê´€í•œ íšŒì› ê°ì²´ë¥¼ ì°¾ëŠ”ë‹¤.

`JSESSIONID` ì¿ í‚¤ê°€ ì ì ˆí•˜ê²Œ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•˜ì.

## ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ê¸° - ì„œë¸”ë¦¿ HTTP ì„¸ì…˜2

### @SessionAttribute

ìŠ¤í”„ë§ì€ ì„¸ì…˜ì„ ë” í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `@SessionAttribute`ì„ ì§€ì›í•œë‹¤.

ì´ë¯¸ ë¡œê·¸ì¸ ëœ ì‚¬ìš©ìë¥¼ ì°¾ì„ ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì°¸ê³ ë¡œ ì´ ê¸°ëŠ¥ì€ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.

`@SessionAttribute(name = "loginMember", required = false) Member loginMember`

**HomeController - homeLoginV3Spring()**

```java
@GetMapping("/")
public String homeLoginV3Spring(@SessionAttribute(name = SessionConst.LOGIN_MEMBER, required = false) Member loginMember, Model model) {

    //ì„¸ì…˜ì— íšŒì› ë°ì´í„°ê°€ ì—†ìœ¼ë©´ home
    if (loginMember == null) {
        return "home";
    }

    //ì„¸ì…˜ì´ ìœ ì§€ë˜ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ ì´ë™
    model.addAttribute("member", loginMember);
    return "loginHome";
}
```

- `homeLoginV3()`ì˜ `@GetMapping(â€/â€)` ì£¼ì„ ì²˜ë¦¬

ì„¸ì…˜ì„ ì°¾ê³ , ì„¸ì…˜ì— ë“¤ì–´ìˆëŠ” ë°ì´í„°ë¥¼ ì°¾ëŠ” ë²ˆê±°ë¡œìš´ ê³¼ì •ì„ ìŠ¤í”„ë§ì´ í•œë²ˆì— í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬í•´ì£¼ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### TrackingModes

ë¡œê·¸ì¸ì„ ì²˜ìŒ ì‹œë„í•˜ë©´ URLì´ ë‹¤ìŒê³¼ ê°™ì´ `jessionid`ë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```java
http://localhost:8080/;jsessionid=F59911518B921DF62D09F0DF8F83F872
```

ì´ê²ƒì€ ì›¹ ë¸Œë¼ìš°ì €ê°€ ì¿ í‚¤ë¥¼ ì§€ì›í•˜ì§€ ì•Šì„ ë•Œ ì¿ í‚¤ ëŒ€ì‹  URLì„ í†µí•´ì„œ ì„¸ì…˜ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì´ë‹¤. ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ë ¤ë©´ URLì— ì´ ê°’ì„ ê³„ì† í¬í•¨í•´ì„œ ì „ë‹¬í•´ì•¼ í•œë‹¤. íƒ€ì„ë¦¬í”„ ê°™ì€ í…œí”Œë¦¿ì€ ì—”ì§„ì„ í†µí•´ì„œ ë§í¬ë¥¼ ê±¸ë©´ `jessionid`ë¥¼ URLì— ìë™ìœ¼ë¡œ í¬í•¨í•´ì¤€ë‹¤. ì„œë²„ ì…ì¥ì—ì„œ ì›¹ ë¸Œë¼ìš°ì €ê°€ ì¿ í‚¤ë¥¼ ì§€ì›í•˜ëŠ”ì§€ í•˜ì§€ ì•ŠëŠ”ì§€ ìµœì´ˆì—ëŠ” íŒë‹¨í•˜ì§€ ëª»í•˜ë¯€ë¡œ, ì¿ í‚¤ ê°’ë„ ì „ë‹¬í•˜ê³ , URLì— `jessionid`ë„ í•¨ê»˜ ì „ë‹¬í•œë‹¤.

URL ì „ë‹¬ ë°©ì‹ì„ ë„ê³  í•­ìƒ ì¿ í‚¤ë¥¼ í†µí•´ì„œë§Œ ì„¸ì…˜ì„ ìœ ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ë‹¤ìŒ ì˜µì…˜ì„ ë„£ì–´ì£¼ë©´ ëœë‹¤. ì´ë ‡ê²Œ í•˜ë©´ URLì— `jessionid`ê°€ ë…¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.

`application.properties`

```java
server.servlet.session.tracking-modes=cookie
```

## ì„¸ì…˜ ì •ë³´ì™€ íƒ€ì„ì•„ì›ƒ ì„¤ì •

### ì„¸ì…˜ ì •ë³´ í™•ì¸

ì„¸ì…˜ì´ ì œê³µí•˜ëŠ” ì •ë³´ë“¤ì„ í™•ì¸í•´ë³´ì.

**SessionInfoController**

```java
package hello.login.web.session;

import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import java.util.Date;

@Slf4j
@RestController
public class SessionInfoController {

    @GetMapping("/session-info")
    public String sessionInfo(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return "ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.";
        }

        //ì„¸ì…˜ ë°ì´í„° ì¶œë ¥
        session.getAttributeNames().asIterator()
                .forEachRemaining(name -> log.info("session name={}, value={}", name, session.getAttribute(name)));

        log.info("sessionId={}", session.getId());
        log.info("getMaxInactiveInterval={}", session.getMaxInactiveInterval());
        log.info("creationTime={}", new Date(session.getCreationTime()));
        log.info("lastAccessedTime={}", new Date(session.getLastAccessedTime()));
        log.info("isNew={}", session.isNew());

        return "ì„¸ì…˜ ì¶œë ¥";
    }
}
```

- `sessionId` : ì„¸ì…˜Id, JSESSIONIDì˜ ê°’ì´ë‹¤.ì˜ˆ)`34B14F008AA3527C9F8ED620EFD7A4E1`
- `maxInactiveInterval` : ì„¸ì…˜ì˜ ìœ íš¨ ì‹œê°„, ì˜ˆ) 1800ì´ˆ, (30ë¶„)
- `creationTime` : ì„¸ì…˜ ìƒì„±ì¼ì‹œ
- `lastAccessedTime` : ì„¸ì…˜ê³¼ ì—°ê²°ëœ ì‚¬ìš©ìê°€ ìµœê·¼ì— ì„œë²„ì— ì ‘ê·¼í•œ ì‹œê°„, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ `sessionId`(`JSESSIONID`)ë¥¼ ìš”ì²­í•œ ê²½ìš°ì— ê°±ì‹ ëœë‹¤.
- `isNew` : ìƒˆë¡œ ìƒì„±ëœ ì„¸ì…˜ì¸ì§€, ì•„ë‹ˆë©´ ì´ë¯¸ ê³¼ê±°ì— ë§Œë“¤ì–´ì¡Œê³ , í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ `sessionId`(`JSESSIONID`)ë¥¼ ìš”ì²­í•´ì„œ ì¡°íšŒëœ ì„¸ì…˜ì¸ì§€ ì—¬ë¶€

### ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •

ì„¸ì…˜ì€ ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒì„ ì§ì ‘ í˜¸ì¶”ë˜ì„œ `session.invalidate()`ê°€ í˜¸ì¶œ ë˜ëŠ” ê²½ìš°ì— ì‚­ì œëœë‹¤.

ê·¸ëŸ°ë° ëŒ€ë¶€ë¶„ì˜ ì‚¬ìš©ìëŠ” ë¡œê·¸ì•„ì›ƒì„ ì„ íƒí•˜ì§€ ì•Šê³ , ê·¸ëƒ¥ ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•œë‹¤. ë¬¸ì œëŠ” HTTPê°€ ë¹„ì—°ê²°ì„±(ConnectionLess)ì´ë¯€ë¡œ ì„œë²„ ì…ì¥ì—ì„œëŠ” í•´ë‹¹ ì‚¬ìš©ìê°€ ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•œ ê²ƒì¸ì§€ ì•„ë‹Œì§€ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ë‹¤. ë”°ë¼ì„œ ì„œë²„ì—ì„œ ì„¸ì…˜ ë°ì´í„°ë¥¼ ì–¸ì œ ì‚­ì œí•´ì•¼ í•˜ëŠ”ì§€ íŒë‹¨í•˜ê¸°ê°€ ì–´ë µë‹¤.

ì´ ê²½ìš° ë‚¨ì•„ìˆëŠ” ì„¸ì…˜ì„ ë¬´í•œì • ë³´ê´€í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

- ì„¸ì…˜ê³¼ ê´€ë ¨ë˜ ì¿ í‚¤(`JSESSIONID`)ë¥¼ íƒˆì·¨ ë‹¹í–ˆì„ ê²½ìš° ì˜¤ëœ ì‹œê°„ì´ ì§€ë‚˜ë„ í•´ë‹¹ ì¿ í‚¤ë¡œ ì•…ì˜ì ì¸ ìš”ì²­ì„ í•  ìˆ˜ ìˆë‹¤.
- ì„¸ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ì— ìƒì„±ëœë‹¤. ë©”ëª¨ë¦¬ì˜ í¬ê¸°ê°€ ë¬´í•œí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ê¼­ í•„ìš”í•œ ê²¨ìš°ë§Œ ìƒì„±í•´ì„œ ìƒìš”í•´ì•¼ í•œë‹¤. 10ë§Œëª…ì˜ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ë©´ 10ë§Œê°œì˜ ì„¸ì…˜ì´ ìƒì„±ë˜ëŠ” ê²ƒì´ë‹¤.

**ì„¸ì…˜ì˜ ì¢…ë£Œ ì‹œì **

ì„¸ì…˜ì˜ ì¢…ë£Œ ì‹œì ì„ ì–´ë–»ê²Œ ì •í•˜ë©´ ì¢‹ì„ê¹Œ? ê°€ì¥ ë‹¨ìˆœí•˜ê²Œ ìƒê°í•´ë³´ë©´, ì„¸ì…˜ ìƒì„± ì‹œì ìœ¼ë¡œë¶€í„° 30ë¶„ ì •ë„ë¡œ ì¡ìœ¼ë©´ ë  ê²ƒ ê°™ë‹¤. ê·¸ëŸ°ë° ë¬¸ì œëŠ” 30ë¶„ì´ ì§€ë‚˜ë©´ ì„¸ì…˜ì´ ì‚­ì œë˜ê¸° ë•Œë¬¸ì—, ì—´ì‹¬íˆ ì‚¬ì´íŠ¸ë¥¼ ëŒì•„ë‹¤ë‹ˆë‹¤ê°€ ë˜ ë¡œê·¸ì¸ì„ í•´ì„œ ì„¸ì…˜ì„ ìƒì„±í•´ì•¼ í•œë‹¤ ê·¸ëŸ¬ë‹ˆê¹Œ 30ë¶„ ë§ˆë‹¤ ê³„ì† ë¡œê·¸ì¸í•´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ë°œìƒí•œë‹¤.

ë” ë‚˜ì€ ëŒ€ì•ˆì€ ì„¸ì…˜ ìƒì„± ì‹œì ì´ ì•„ë‹ˆë¼ ì‚¬ìš©ìê°€ ì„œë²„ì— ìµœê·¼ì— ìš”ì²­í•œ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ 30ë¶„ ì •ë„ë¥¼ ìœ ì§€í•´ì£¼ëŠ” ê²ƒì´ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©´, ì„¸ì…˜ì˜ ìƒì¡´ ì‹œê°„ì´ 30ë¶„ìœ¼ë¡œ ê³„ì† ëŠ˜ì–´ë‚˜ê²Œ ëœë‹¤. ë”°ë¼ì„œ 30ë¶„ ë§ˆë‹¤ ë¡œê·¸ì¸í•´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ì‚¬ë¼ì§„ë‹¤. `HttpSession`ì€ ì´ ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.

**ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •**

ìŠ¤í”„ë§ ë¶€íŠ¸ë¡œ ê¸€ë¡œë²Œ ì„¤ì •

`application.properties`

```java
server.servlet.session.timeout=60 //60ì´ˆ, ê¸°ë³¸ì€ 1800(30ë¶„)
```

(ê¸€ë¡œë²Œ ì„¤ì •ì€ ë¶„ ë‹¨ìœ„ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. 60(1ë¶„), 120(2ë¶„), ...)

íŠ¹ì • ì„¸ì…˜ ë‹¨ìœ„ë¡œ ì‹œê°„ ì„¤ì •

```java
session.setMaxInactiveInterval(1800); //1800ì´ˆ
```

**ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ë°œìƒ**

ì„¸ì…˜ì˜ íƒ€ì„ì•„ì›ƒ ì‹œê°„ì€ í•´ë‹¹ ì„¸ì…˜ê³¼ ê´€ë ¨ëœ `JSESSIONID`ë¥¼ ì „ë‹¬í•˜ëŠ” HTTP ìš”ì²­ì´ ìˆìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ë‹¤ì‹œ ì´ˆê¸°í™” ëœë‹¤. ì´ë ‡ê²Œ ë˜ë©´ ì„¸ì…˜ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì„¤ì •í•œ ì‹œê°„ë™ì•ˆ ì„¸ì…˜ì„ ì¶”ê°€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë”°.

`session.getLastAccessdTime()` : ìµœê·¼ ì„¸ì…˜ ì ‘ê·¼ ì‹œê°„

`LastAccessdTime` ì´í›„ë¡œ timeout ì‹œê°„ì´ ì§€ë‚˜ë©´, WASê°€ ë‚´ë¶€ì—ì„œ í•´ë‹¹ ì„¸ì…˜ì„ ì œê±°í•œë‹¤.

**ì •ë¦¬**

ì„œë¸”ë¦¿ì˜ `HttpSession`ì´ ì œê³µí•˜ëŠ” íƒ€ì„ì•„ì›ƒ ê¸°ëŠ¥ ë•ë¶„ì— ì„¸ì…˜ì„ ì•ˆì „í•˜ê³  í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ì‹¤ë¬´ì—ì„œ ì£¼ì˜í•  ì ì€ ì„¸ì…˜ì—ëŠ” ìµœì†Œí•œì˜ ë°ì´í„°ë§Œ ë³´ê´€í•´ì•¼ í•œë‹¤ëŠ” ì ì´ë‹¤. ë³´ê´€í•  ë°ì´í„° ìš©ëŸ‰ * ì‚¬ìš©ì ìˆ˜ë¡œ ì„¸ì…˜ì˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ê¸‰ê²©í•˜ê²Œ ëŠ˜ì–´ë‚˜ì„œ ì¥ì• ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆë‹¤. ì¶”ê°€ë¡œ ì„¸ì…˜ì˜ ì‹œê°„ì„ ë„ˆë¬´ ê¸¸ê²Œ ê°€ì ¸ê°€ë©´ ë©”ëª¨ë¦¬ ì‚¬ìš©ì´ ê³„ì† ëˆ„ì  ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ë‹¹í•œ ì‹œê°„ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤. ê¸°ë³¸ì´ 30ë¶„ì´ë¼ëŠ” ê²ƒì„ ê¸°ì¤€ìœ¼ë¡œ ê³ ë¯¼í•˜ë©´ ëœë‹¤.